<polymer-element name="timeline-panel"
                 attributes="fromDate, toDate, monthsNames, monthHeaderStyle, monthTextStyle, dayTextStyle, userTextStyle, rowHeight, rows, colorsForRows, invisibleDays">
    <template>
        <style no-shim>
            .month-header {
                {{monthHeaderStyle}}
                ;
                top: 0px;
                position: absolute;
            }
            .month-text {
                {{monthTextStyle}}
            }
            .day-text {
                {{dayTextStyle}}
                ;
                position: absolute;
            }
            .user-text {
                {{userTextStyle}}
                ;
                position: absolute;
            }
            .full-view {
                width: 100%;
                height: 100%;
                position: relative;
            }
        </style>
            <div class="full-view">
            <span id="monthsHeaders"></span>
            <span id="daysHeaders"></span>
            <span id="users"></span>
            <span id="entries"></span>
            </div>
    </template>
    <script>
    if(window.$mmWebcompUtils$ == undefined)
        window.$mmWebcompUtils$ = {};
    if(window.$mmWebcompUtils$.timeline == undefined) {
        window.$mmWebcompUtils$.timeline = {};
        window.$mmWebcompUtils$.timeline.daysdiff = function(from, to) {
            return (to - from) / (1000 * 60 * 60 * 24);
        }

        window.$mmWebcompUtils$.timeline.incrementByDay = function(date) {
            date.setDate(date.getDate() + 1);
            return date;
        }

        window.$mmWebcompUtils$.timeline.daysadd = function(date, amount) {
            var result = new Date(date.getFullYear(), date.getMonth(), date.getDate());
            result.setDate(date.getDate() + amount - 1);
            return result;
        }

        window.$mmWebcompUtils$.timeline.positionInElement = function(element, e) {
            return {
                x: e.clientX - element.offsetLeft,
                y: e.clientY - element.offsetTop
            }
        }
    }
    Polymer({
        // --- const
        MIN_COL_WIDTH: 20,
        LEFT_PANEL_WIDTH: 100,
        BACKGROUND_STYLE: 'white',
        // --- object fields
        maxDays: 31,
        headerHeight: 0,
        from: null,
        to: null,
        rows: [],
        rowHeight: 20,
        monthsNames: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
        monthHeaderStyle: "height: 40px; display: table; overflow: hidden; background-color: SkyBlue; border-radius: 5px; top: 0px;",
        monthTextStyle: "color: white; display: table-cell; vertical-align:top; padding-top:3px; text-align:center; font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial; overflow: hidden;",
        userTextStyle: "font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial; left: 2px;",
        dayTextStyle: "font-family: RobotoDraft, 'Helvetica Neue', Helvetica, Arial; font-size: 10px; top: 28px; text-align:center; ",
        colorsForRows: ["FireBrick", "GreenYellow", "HotPink"],
        invisibleDays: [6,0],
        amountOfDays: function () {
            return
        },
        recalculateMaximumAmountOfDays: function()  {
            if ((this.parentElement.clientWidth - this.LEFT_PANEL_WIDTH) / this.maxDays < this.MIN_COL_WIDTH) 
                this.maxDays = Math.round((this.parentElement.clientWidth - this.LEFT_PANEL_WIDTH) / this.MIN_COL_WIDTH);
        },
        getVisibleDays: function() {
            var amount = 0;
            var tmpDate = new Date(this.from.getFullYear(), this.from.getMonth(), this.from.getDate());
            var lastMonth = -1;
            var result = {};
            var daysForLastMonth = [];
            while(amount < this.maxDays) {
                if(this.invisibleDays.indexOf(tmpDate.getDay()) == -1) {
                    if(tmpDate.getMonth() != lastMonth && daysForLastMonth.length > 0) {
                        result[lastMonth] = daysForLastMonth;
                        daysForLastMonth = [];
                    }
                    lastMonth = tmpDate.getMonth();
                    daysForLastMonth.push(tmpDate.getDate());
                    amount++;
                }
                window.$mmWebcompUtils$.timeline.incrementByDay(tmpDate);
                if(this.to != undefined && tmpDate > this.to) {
                    break;
                }
            }
            if(daysForLastMonth.length > 0) {
                result[lastMonth] = daysForLastMonth;
            }
            return result;
        },
        // --- events
        ready: function() {
            if(this.fromDate == null) {
                this.from = new Date();
            } else {
                this.from = new Date(this.fromDate);
            }
            this.recalculateMaximumAmountOfDays();
            this.getVisibleDays();
            this.addEventListener("click", this.onMouseClick);
            this.render();
            Polymer.import(["entry.html"]);
        },
        onMouseClick: function(e) {
            var pos = window.$mmWebcompUtils$.timeline.positionInElement(this, e);
            console.log(pos.x + "::" + pos.y);
        },
        // --- rendering functions
        render: function() {
            var colWidth = Math.round((this.parentElement.clientWidth-this.LEFT_PANEL_WIDTH) / this.amountOfDays());
            this.renderMonthHeaders(colWidth);
            this.renderDaysNumbers(colWidth);
            this.renderUserNames();
            this.renderEntries(colWidth);
        },
        renderMonthHeaders: function(colWidth) {
            var dateIter = new Date(this.from.getFullYear(), this.from.getMonth(), this.from.getDate());
            var html = '';
            var previousMonth = -1;
            var length = 0;
            var start = 0;
            for (var i = 0; i < this.amountOfDays; i++) {
                if(dateIter.getMonth() != previousMonth) {
                    if(start != length) {
                        html += this.prepareHtmlForMonth(this.monthsNames[previousMonth], start, length);
                        start += length;
                        length = 0;
                    }
                    previousMonth = dateIter.getMonth();
                }
                length += colWidth;
                dateIter.setDate(dateIter.getDate() + 1);
            }
            html += this.prepareHtmlForMonth(this.monthsNames[dateIter.getMonth()], start, length);
            this.$.monthsHeaders.innerHTML = html;
            this.headerHeight = this.$.monthsHeaders.firstChild.clientHeight;
        },
        prepareHtmlForMonth: function(month, offset, length) {
            return '<div class="month-header" style="left:'+(this.LEFT_PANEL_WIDTH+offset)+'px;"><span class="month-text" style="width:'+(length-1)
                    +'px;max-width:'+(length-1)+'px;">'+month+'</span></div>';
        },
        renderDaysNumbers: function (colWidth) {
            var dateIter = new Date(this.from.getFullYear(), this.from.getMonth(), this.from.getDate());
            var html = '';
            var offset = 0;
            for (var i = 0; i < this.amountOfDays; i++) {
                html += this.prepareHtmlForDay(dateIter.getDate(), offset, colWidth);
                dateIter.setDate(dateIter.getDate() + 1);
                offset += colWidth;
            }
            this.$.daysHeaders.innerHTML = html;
        },
        prepareHtmlForDay: function(day, offset, length) {
            return '<div class="day-text" style="left:'+(this.LEFT_PANEL_WIDTH+offset)
                    +'px;width:'+length+'px;">'+day+'</div>';
        },
        renderUserNames: function() {
            var html = "";
			var offset = this.headerHeight;
            for(var row of this.rows) {
                html += '<div class="user-text" style="top:'+offset+'px;">'+row.label+'</div>';
				offset += this.rowHeight;
            }
            this.$.users.innerHTML = html;
        },

        renderEntries: function(colWidth) {
            var element;
            var offset = this.headerHeight;
            var fromDate, toDate;
            var entryFromColumn, entryAmountOfColumns;
	        var colorIndex = 0;
            for(var row of this.rows) {
                for(var entry of row.entries) {
                    fromDate = Math.max(new Date(entry.from),this.from);
                    toDate = Math.min(new Date(entry.to),this.to);
                    entryFromColumn = window.$mmWebcompUtils$.timeline.daysdiff(this.from, fromDate);
                    if(entryFromColumn < this.amountOfDays) {
                        entryAmountOfColumns = window.$mmWebcompUtils$.timeline.daysdiff(fromDate, toDate)+1;
                        element = document.createElement("timeline-entry");
                        element.top=offset+'px';
                        element.left=(this.LEFT_PANEL_WIDTH+colWidth*entryFromColumn)+'px';
                        element.width=(colWidth*entryAmountOfColumns)+'px';
                        element.height=this.rowHeight+'px';
                        element.color=this.colorsForRows[colorIndex];
                        this.$.entries.appendChild(element);
                    }
                }
                offset += this.rowHeight;
                colorIndex = (colorIndex+1)%this.colorsForRows.length;
            }
        }
    });
    </script>
</polymer-element>
